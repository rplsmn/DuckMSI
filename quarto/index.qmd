---
title: "DuckMSI - Privacy-First Parquet Explorer"
format:
  html:
    page-layout: full
---

```{ojs}
//| echo: false

// Import DuckDB WASM
duckdb = {
  const duckdb = await import("https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm");
  return duckdb;
}

// Initialize DuckDB
db = {
  const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
  const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

  const worker_url = URL.createObjectURL(
    new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
  );

  const worker = new Worker(worker_url);
  const logger = new duckdb.ConsoleLogger();
  const db = new duckdb.AsyncDuckDB(logger, worker);

  await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
  URL.revokeObjectURL(worker_url);

  return db;
}

conn = db.connect()

// Status indicator - small green check
viewof status = {
  const span = html`<span class="status-indicator"><span style="color: #28a745; font-size: 14px;">âœ“</span> DuckDB Ready</span>`;
  return span;
}
```

::: {.card}
## 1. Upload Parquet File

```{ojs}
//| echo: false

// File input
viewof parquetFile = Inputs.file({
  label: "Choose a .parquet file",
  accept: ".parquet",
  required: false
})

// Process uploaded file
loadedFile = {
  if (!parquetFile) return null;

  const buffer = await parquetFile.arrayBuffer();
  const fileName = parquetFile.name;

  // Register file with DuckDB
  const connection = await conn;
  await db.registerFileBuffer(fileName, new Uint8Array(buffer));

  return fileName;
}

// Display loaded file
{
  if (loadedFile) {
    return html`<div class="file-loaded">
      <span class="file-tag">${loadedFile}</span> loaded successfully
    </div>`;
  }
  return html`<div class="file-hint">No file loaded yet. Upload a .parquet file to get started.</div>`;
}

// Calculate file statistics
fileStats = {
  if (!loadedFile) return null;

  try {
    const connection = await conn;

    // Get row count
    const countResult = await connection.query(`SELECT COUNT(*) as count FROM '${loadedFile}'`);
    const rowCount = countResult.toArray()[0].count;

    // Get column information
    const tableInfoResult = await connection.query(`DESCRIBE SELECT * FROM '${loadedFile}'`);
    const tableInfo = tableInfoResult.toArray();
    const columnCount = tableInfo.length;

    // Get unique row count
    const columns = tableInfo.map(col => col.column_name).join(', ');
    const uniqueResult = await connection.query(`SELECT COUNT(*) as count FROM (SELECT DISTINCT ${columns} FROM '${loadedFile}')`);
    const uniqueRowCount = uniqueResult.toArray()[0].count;

    return {
      rowCount: Number(rowCount),
      columnCount,
      uniqueRowCount: Number(uniqueRowCount)
    };
  } catch (e) {
    console.error('Failed to get file statistics:', e);
    return null;
  }
}

// Display diagnostics dashboard
{
  if (fileStats) {
    return html`<div class="diagnostics-dashboard">
      <div class="value-box row-count">
        <div class="value-box-label">Total Rows</div>
        <div class="value-box-value">${fileStats.rowCount.toLocaleString()}</div>
        <div class="value-box-sublabel">records in dataset</div>
      </div>
      <div class="value-box column-count">
        <div class="value-box-label">Columns</div>
        <div class="value-box-value">${fileStats.columnCount.toLocaleString()}</div>
        <div class="value-box-sublabel">fields available</div>
      </div>
      <div class="value-box unique-count">
        <div class="value-box-label">Unique Rows</div>
        <div class="value-box-value">${fileStats.uniqueRowCount.toLocaleString()}</div>
        <div class="value-box-sublabel">distinct observations</div>
      </div>
    </div>`;
  }
  return html``;
}
```
:::

::: {.card}
## 2. Enter SQL Query

```{ojs}
//| echo: false

// Default query based on loaded file
defaultQuery = loadedFile
  ? `SELECT * FROM '${loadedFile}' LIMIT 10`
  : "SELECT * FROM 'your_file.parquet' LIMIT 10"

// SQL input
viewof sqlQuery = Inputs.textarea({
  label: "SQL Query",
  placeholder: "SELECT * FROM 'your_file.parquet' LIMIT 10",
  value: defaultQuery,
  rows: 4,
  width: "100%",
  monospace: true
})

// Mutable variable to store the query to execute
mutable lastExecutedQuery = ""

// Execute button - updates mutable when clicked
viewof executeClicked = Inputs.button("Execute Query", {
  disabled: !loadedFile,
  reduce: () => {
    mutable lastExecutedQuery = sqlQuery;
    return Math.random(); // Return random value to trigger reactivity
  }
})
```
:::

::: {.card}
## 3. Query Results

```{ojs}
//| echo: false

// Execute query and get results
queryResults = {
  // Trigger on button click
  executeClicked;

  if (!loadedFile || !lastExecutedQuery.trim()) {
    return { columns: [], rows: [], error: null, message: "Upload a file and enter a query to see results." };
  }

  try {
    const connection = await conn;
    const result = await connection.query(lastExecutedQuery);
    const data = result.toArray();

    if (data.length === 0) {
      return { columns: [], rows: [], error: null, message: "Query returned no results." };
    }

    const columns = Object.keys(data[0]);
    const rows = data.slice(0, 50).map(row => columns.map(col => row[col]));

    return { columns, rows, error: null, message: null };
  } catch (e) {
    return { columns: [], rows: [], error: e.message, message: null };
  }
}

// Display results
{
  if (queryResults.error) {
    return html`<div class="error">Error: ${queryResults.error}</div>`;
  }

  if (queryResults.message) {
    return html`<div class="message">${queryResults.message}</div>`;
  }

  if (queryResults.rows.length === 0) {
    return html`<div class="message">No results to display.</div>`;
  }

  // Build table with explicit DOM construction
  const table = document.createElement('table');
  table.className = 'results-table';

  // Create header
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  queryResults.columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);

  // Create body
  const tbody = document.createElement('tbody');
  queryResults.rows.forEach(row => {
    const tr = document.createElement('tr');
    row.forEach(cell => {
      const td = document.createElement('td');
      td.textContent = cell !== null && cell !== undefined ? String(cell) : 'NULL';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  return html`<div class="results-container">${table}</div>`;
}

// Row count
{
  if (queryResults.rows.length > 0) {
    return html`<div class="row-count">Showing ${queryResults.rows.length} rows (limit 50)</div>`;
  }
  return html``;
}
```
:::

::: {.privacy-note}
**Privacy First**: All data processing happens entirely in your browser. Your data never leaves your device.
:::
